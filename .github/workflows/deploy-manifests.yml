name: Generate manifests and deploy

on:
  workflow_run:
    workflows: ["Build docker images"]
    types:
      - completed
    branches: ["chore/deploy"]

env:
  GITOPS_REPO: fabrique-atlas/org-sdpsn-ws-sirena

jobs:
  deploy:
    name: Generate manifests and deploy
    runs-on: ubuntu-latest
    # if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          cd deploy
          npm ci
      
      - name: Check format and lint
        run: |
          cd deploy
          npm run lint

      - name: Render manifests
        run: |
          cd deploy
          npm run build

      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          path: gitops-repo
          ssh-key: ${{ secrets.GITOPS_REPO_KEY }}

      - run: |
          rm -f gitops-repo/deployment-targets/test
          cp -r deploy/dist gitops-repo/deployment-targets/test

          git config --global user.name "github-actions[bot]"
          # mail standard bot github Actions  
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          cd gitops-repo
          git add .
          git commit -m '[test] new version ${{ env.SHORT_SHA }}'
          git push 